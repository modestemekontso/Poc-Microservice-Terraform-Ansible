# Docker Compose for Microservices Stack
# Production-ready configuration with health checks and proper networking

# version: '3.8'

# Shared network for all services
networks:
  microservices-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

# Persistent volumes for databases
volumes:
  customerdb-data:
    driver: local
  orderdb-data:
    driver: local
  catalogdb-data:
    driver: local
  rabbitmq-data:
    driver: local

services:
  # ==================== Databases ====================
  
  customerdb:
    image: postgres:15-alpine
    container_name: customerdb
    restart: unless-stopped
    environment:
      POSTGRES_DB: customerdb
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${CUSTOMERDB_PASSWORD:-postgres}
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - customerdb-data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    networks:
      microservices-network:
        ipv4_address: 172.28.0.10
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d customerdb"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  orderdb:
    image: postgres:15-alpine
    container_name: orderdb
    restart: unless-stopped
    environment:
      POSTGRES_DB: orderdb
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${ORDERDB_PASSWORD:-postgres}
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - orderdb-data:/var/lib/postgresql/data
    ports:
      - "5433:5432"
    networks:
      microservices-network:
        ipv4_address: 172.28.0.11
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d orderdb"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  catalogdb:
    image: postgres:15-alpine
    container_name: catalogdb
    restart: unless-stopped
    environment:
      POSTGRES_DB: catalogdb
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${CATALOGDB_PASSWORD:-postgres}
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - catalogdb-data:/var/lib/postgresql/data
    ports:
      - "5434:5432"
    networks:
      microservices-network:
        ipv4_address: 172.28.0.12
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d catalogdb"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # ==================== Message Broker ====================
  
  rabbitmq:
    image: rabbitmq:3.12-management-alpine
    container_name: rabbitmq
    restart: unless-stopped
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER:-guest}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD:-guest}
      RABBITMQ_DEFAULT_VHOST: /
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq
    ports:
      - "5672:5672"   # AMQP port
      - "15672:15672" # Management UI
    networks:
      microservices-network:
        ipv4_address: 172.28.0.20
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # ==================== Microservices ====================
  
  customer-service:
    build:
      context: ./CustomerService
      dockerfile: Dockerfile
    image: customer-service:${VERSION:-latest}
    container_name: customer-service
    restart: unless-stopped
    ports:
      - "5001:8080"
    environment:
      # Database Configuration
      ConnectionStrings__DefaultConnection: "Host=customerdb;Port=5432;Database=customerdb;Username=postgres;Password=${CUSTOMERDB_PASSWORD:-postgres};Pooling=true;Minimum Pool Size=0;Maximum Pool Size=100;"
      
      # RabbitMQ Configuration
      RabbitMQ__Host: rabbitmq
      RabbitMQ__Port: 5672
      RabbitMQ__Username: ${RABBITMQ_USER:-guest}
      RabbitMQ__Password: ${RABBITMQ_PASSWORD:-guest}
      RabbitMQ__VirtualHost: /
      
      # Application Settings
      ASPNETCORE_ENVIRONMENT: ${ENVIRONMENT:-Production}
      ASPNETCORE_URLS: http://+:8080
      
      # Logging
      Logging__LogLevel__Default: Information
      Logging__LogLevel__Microsoft: Warning
      
    depends_on:
      customerdb:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      microservices-network:
        ipv4_address: 172.28.0.30
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  order-service:
    build:
      context: ./OrderService
      dockerfile: Dockerfile
    image: order-service:${VERSION:-latest}
    container_name: order-service
    restart: unless-stopped
    ports:
      - "5002:8080"
    environment:
      # Database Configuration
      ConnectionStrings__DefaultConnection: "Host=orderdb;Port=5432;Database=orderdb;Username=postgres;Password=${ORDERDB_PASSWORD:-postgres};Pooling=true;Minimum Pool Size=0;Maximum Pool Size=100;"
      
      # RabbitMQ Configuration
      RabbitMQ__Host: rabbitmq
      RabbitMQ__Port: 5672
      RabbitMQ__Username: ${RABBITMQ_USER:-guest}
      RabbitMQ__Password: ${RABBITMQ_PASSWORD:-guest}
      RabbitMQ__VirtualHost: /
      
      # Service URLs (HTTP communication)
      CustomerService__BaseUrl: http://customer-service:8080
      CustomerService__HealthEndpoint: /health
      CatalogService__BaseUrl: http://catalog-service:8080
      CatalogService__HealthEndpoint: /health
      
      # Application Settings
      ASPNETCORE_ENVIRONMENT: ${ENVIRONMENT:-Production}
      ASPNETCORE_URLS: http://+:8080
      
      # Logging
      Logging__LogLevel__Default: Information
      Logging__LogLevel__Microsoft: Warning
      
    depends_on:
      orderdb:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      customer-service:
        condition: service_healthy
      catalog-service:
        condition: service_healthy
    networks:
      microservices-network:
        ipv4_address: 172.28.0.31
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  catalog-service:
    build:
      context: ./CatalogService
      dockerfile: Dockerfile
    image: catalog-service:${VERSION:-latest}
    container_name: catalog-service
    restart: unless-stopped
    ports:
      - "5003:8080"
    environment:
      # Database Configuration
      ConnectionStrings__DefaultConnection: "Host=catalogdb;Port=5432;Database=catalogdb;Username=postgres;Password=${CATALOGDB_PASSWORD:-postgres};Pooling=true;Minimum Pool Size=0;Maximum Pool Size=100;"
      
      # RabbitMQ Configuration
      RabbitMQ__Host: rabbitmq
      RabbitMQ__Port: 5672
      RabbitMQ__Username: ${RABBITMQ_USER:-guest}
      RabbitMQ__Password: ${RABBITMQ_PASSWORD:-guest}
      RabbitMQ__VirtualHost: /
      
      # Application Settings
      ASPNETCORE_ENVIRONMENT: ${ENVIRONMENT:-Production}
      ASPNETCORE_URLS: http://+:8080
      
      # Logging
      Logging__LogLevel__Default: Information
      Logging__LogLevel__Microsoft: Warning
      
    depends_on:
      catalogdb:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      microservices-network:
        ipv4_address: 172.28.0.32
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
